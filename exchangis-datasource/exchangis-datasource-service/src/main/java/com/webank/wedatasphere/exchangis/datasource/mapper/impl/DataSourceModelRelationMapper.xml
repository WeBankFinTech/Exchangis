<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.webank.wedatasphere.exchangis.datasource.mapper.DataSourceModelRelationMapper">
    <resultMap id="relationResult" type="com.webank.wedatasphere.exchangis.datasource.core.domain.DataSourceModelRelation">
        <id property="id" column="id"/>
        <result property="modelId" column="model_id"/>
        <result property="dsId" column="ds_id"/>
        <result property="dsName" column="ds_name"/>
        <result property="dsVersion" column="ds_version"/>
        <result property="createUser" column="create_user"/>
        <result property="createTime" column="create_time"/>
        <result property="modifyUser" column="modify_user"/>
        <result property="modifyTime" column="modify_time"/>
    </resultMap>

    <sql id="table">
        exchangis_data_source_model_relation
    </sql>

    <sql id="columns">
        id, model_id, ds_id, ds_name, ds_version,
        create_user, create_time, modify_user, modify_time
    </sql>

    <insert id="addDsModelRelation" useGeneratedKeys="true" keyProperty="id">
        <foreach collection="list" item="item" open="" close="" separator="">
            <![CDATA[
                INSERT INTO exchangis_data_source_model_relation (
                 model_id, ds_id, ds_name, ds_version,
                 create_user, create_time
                ) VALUES (
                 #{item.modelId},
                 #{item.dsId},
                 #{item.dsName},
                 #{item.dsVersion},
                 #{item.createUser},
                 #{item.createTime}
                );
            ]]>
        </foreach>
    </insert>

    <update id="updateDsModelRelation">
        <foreach collection="list" item="item" separator="">
            <![CDATA[
                UPDATE exchangis_data_source_model_relation SET
                ds_name = #{item.dsName},
                ds_version = #{item.dsVersion},
                model_id = #{item.modelId},
                ds_id = #{item.dsId},
                create_user = #{item.createUser},
                modify_user = #{item.modifyUser}
                WHERE
                id = #{item.id};
            ]]>
        </foreach>
    </update>

    <delete id="deleteDsModelRelation">
        DELETE FROM <include refid="table"/> WHERE
        ds_name = #{dsName}
        AND ds_version = #{dsVersion};
    </delete>

    <delete id="deleteDsModelByDsId">
        DELETE FROM <include refid="table"/> WHERE
        ds_id = #{dsId};
    </delete>

    <select id="queryDsIdsByModel" resultMap="relationResult">
        SELECT
        data_source_id
        FROM <include refid="table"/>
        WHERE model_id = #{modelId}
        ORDER BY create_time DESC
    </select>

    <select id="queryDsModelRelation" resultMap="relationResult">
        SELECT
        <include refid="columns"/>
        FROM <include refid="table"/>
        <include refid="findPageWhere"/>
        ORDER BY create_time DESC
    </select>

    <sql id="findPageWhere">
        <where>
            <if test="dsName != null and dsName != ''">
                AND ds_name = #{dsName}
            </if>
            <if test="dsVersion != null">
                AND ds_version = #{dsVersion}
            </if>
            <if test="modelId != null">
                AND model_id = #{modelId}
            </if>
            <if test="dsId != null">
                AND ds_id = #{dsId}
            </if>
            <if test="createUser != null and createUser != ''">
                AND create_user = #{createUser}
            </if>
            <if test="modifyUser != null and modifyUser != ''">
                AND modify_user = #{modifyUser}
            </if>
        </where>
    </sql>

</mapper>